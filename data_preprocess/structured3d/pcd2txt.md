## 📐 墙体、门窗导出需求规范

### 1. 数据来源
- 输入文件：Structured3D 格式的 `annotation_3d.json`  
- 核心字段：
  - `semantics`：描述房间（如 livingroom、bedroom）的组成平面
  - `planes`：定义平面，带有 `type` 属性（wall / outwall / floor / ceiling / door / window 等）
  - `junctions` + `lines` + `planeLineMatrix`：用于解析平面边界几何

---

### 2. 墙体表示 (Wall)
- **仅包含实体内墙**
  - 从房间 `semantics` 中筛选 `type=="wall"` 的平面  
  - 排除 `outwall`（外墙）、虚拟墙面（开口边界用的辅助面）
- **完整矩形表示**
  - 每个墙体输出为一个完整矩形面（不做门窗减孔）  
  - 底边由该平面在水平面的最小/最大范围与房间地面高度相交确定  
  - 墙高取该房间的实际高度（floor → ceiling）
- **输出格式**
  ```text
  wall_k = Wall(ax, ay, az, bx, by, bz, height, thickness)
  ```
  - `(ax,ay,az)` → 底边起点  
  - `(bx,by,bz)` → 底边终点  
  - `height` → 房间高度  
  - `thickness` → 墙厚（当前默认 0.0，可扩展）

---

### 3. 门和窗表示 (Door / Window)
- **几何来源**
  - 门窗由 `semantics` 中 `type=="door"/"window"` 的四个平面解析  
  - 利用所有角点的 Z 坐标 (`minZ, maxZ`) 得到实际高度与中心位置
- **挂靠墙体**
  - 门窗通过平面邻接关系挂到对应的墙 `wall_k` 上  
  - 输出时需指定 `wall_id`
- **与墙体平面一致性**
  - 门窗必须与挂靠的墙共面：  
    - 保证门/窗开口整体的主平面与挂靠的墙平面一致（两者共面，法向一致，偏移差在容差范围内）   
    - 校验法向量一致，offset 差值 ≤ 容差（如 1cm）  
    - 将门窗中心 `(cx,cy)` 投影到墙平面，保证共面  
  - 输出时使用修正后的点坐标
- **跨房间的门窗重复挂靠**：当门/窗连接两个房间时，应在两面相邻墙体上分别生成一份门/窗实体。两份门/窗在几何位置和尺寸上完全一致，但分别挂靠在不同房间的墙体上。
- **输出格式**
  ```text
  door_i   = Door(wall_id, cx, cy, cz, width, height)
  window_j = Window(wall_id, cx, cy, cz, width, height)
  ```
  - `(cx,cy,cz)` → 开口中心位置  
  - `width` → 左右 jamb 面之间的距离  
  - `height` → `maxZ - minZ`（实际开口高度）

---

### 4. 房间级别处理
- **逐房间计算高度**
  - 每个房间独立计算 `z_floor` 和 `z_ceiling`  
  - 墙体高度以该房间为准，而非全局统一




## `pcd2txt.py` 实现逻辑说明

本文档详细说明 `pcd2txt.py` 脚本的核心算法，用于从 `Structured3D` JSON 文件中解析并提取建筑的墙体、门和窗的布局。

### 1. 总体流程：`extract_layout` 函数详解

脚本的核心是 `extract_layout` 函数，它协调所有模块，按以下精确步骤执行：

1.  **初始化**: 创建三个空的列表 `walls`, `doors`, `windows` 用于存储最终结果。

2.  **提取房间定义**: 调用 `extract_rooms` 函数，遍历 `semantics` 列表，将所有非门窗的语义对象（如 `livingroom`, `bedroom` 等）归类，形成一个按房间类型组织的字典 `rooms`。

3.  **第一阶段：遍历房间以生成全部墙体**:
    a.  对 `rooms` 字典进行双层遍历，首先是房间类型（`room_type`），然后是该类型下的每个具体房间实例（`room`）。
    b.  **计算房间高度**: 对每个 `room`，调用 `calculate_room_height`，通过分析其地板和天花板平面的Z坐标，计算出该房间专属的地面高度 `z_floor` 和总高度 `height`。
    c.  **提取墙体**: 遍历该 `room` 包含的所有墙体平面ID (`wall_planes`)。
    d.  对每个墙体平面ID，调用 `extract_wall_geometry` 函数（传入该房间的 `z_floor` 和 `height`），生成一个 `Wall` 对象。
    e.  为生成的 `Wall` 对象分配一个全局唯一的 `id`，并将其添加到全局的 `walls` 列表中。

4.  **第二阶段：遍历语义对象以生成所有门窗**:
    a.  再次遍历原始的 `semantics` 列表，这次专门寻找 `type` 为 "door" 或 "window" 的对象。
    b.  **计算门窗几何**: 对每个找到的门/窗对象，调用 `extract_opening_geometry` 函数，计算其精确的几何属性（宽度、高度、中心点、法向量），返回一个临时的 `Opening` 对象。
    c.  **查找邻接墙体**: 调用 `find_adjacent_walls` 函数，传入当前的门/窗对象和**完整的全局 `walls` 列表**。此函数通过分析拓扑关系（共享线），返回一个包含所有与该门窗邻接的 `Wall` 对象的列表。
    d.  **对齐并创建对象**: 遍历上一步返回的邻接 `Wall` 列表。
        i.  对于每一个邻接的 `wall`，调用 `align_opening_to_wall` 函数，将门窗的原始中心点投影到该 `wall` 的平面上，得到修正后的坐标 `(cx, cy, cz)`。
        ii. 使用修正后的坐标、之前计算的几何属性以及当前 `wall` 的 `id`，创建一个 `Door` 或 `Window` 对象。
        iii. 将创建好的对象添加到全局的 `doors` 或 `windows` 列表中。
        - *（由于一个门/窗可能连接两个房间，它会挂靠到两面不同的墙上，此循环会为它创建两个独立的、但几何属性相同的对象，只是 `wall_id` 不同）*

5.  **返回结果**: 函数最终返回包含所有结果的元组 `(walls, doors, windows)`。

---

### 2. 核心模块详解

#### 2.1. 墙体提取 (`extract_wall_geometry`)

-   **功能**: 将一个墙体平面（Plane）的几何数据转换为一个 `Wall` 对象。
-   **算法**:
    1.  **获取顶点**: 解析输入平面所关联的所有三维顶点坐标。
    2.  **确定底边**: 将所有顶点在XY平面上进行投影。算法在所有投影点中寻找到距离最远的一对点，这两个点即被视为墙体底边的起点和终点。
        -   *注：此算法基于数据中所有墙体均为直线墙的前提。*
    3.  **构建墙体**: 使用底边端点的XY坐标、当前房间的地面高度 `z_floor` 和房间总高度 `height` 来构建具有三维尺寸的 `Wall` 对象。

#### 2.2. 门窗几何计算 (`extract_opening_geometry`)

-   **功能**: 计算门/窗的精确几何属性，包括宽度、高度、中心点和法向量。
-   **算法**:
    1.  **识别平面组**: 脚本首先对构成门窗的平面进行分类。通过计算平面法向量与世界Z轴 `(0, 0, 1)` 的点积，将平面分为**水平面（上下）**和**垂直面（左右）**。
    2.  **计算宽度**: 门窗的宽度由**垂直面（左右）**决定。脚本读取这两个平面的 `offset` 字段，宽度即为两个 `offset` 值的绝对值之和 (`abs(offset1 + offset2)`)。
    3.  **计算高度与中心**: 脚本获取门窗所有相关平面的全部角点，并计算这些角点的三维包围盒。
        -   **高度** (`height`) 是包围盒的Z轴尺寸 (`max_z - min_z`)。
        -   **中心点** (`cx, cy, cz`) 是包围盒的几何中心。
    4.  **计算法向量**: 门窗主平面的朝向（法向量）由其**垂直面（左右）**的朝向决定。脚本通过计算垂直面法向量与世界Z轴的叉积，得到一个与地面平行且指向开口外部的法向量。

#### 2.3. 墙体挂靠 (`find_adjacent_walls`)

-   **功能**: 为每个门/窗找到其在物理上所邻接的墙体。
-   **算法**:
    1.  **基于拓扑邻接**: 此算法的核心是利用 `planeLineMatrix` 中定义的几何拓扑关系。
    2.  **共享线查找**: 对于一个门/窗对象，脚本会遍历构成它的所有平面。对于其中每一个平面，它会查找与该平面**共享同一条线（Line）** 的所有其他平面。
    3.  **识别墙体**: 如果一个共享线的平面是墙体（`type=="wall"`），那么这面墙就被确定为该门/窗的挂靠墙体。
    4.  脚本返回所有找到的邻接墙体列表。一个门窗通常会连接两个房间，因此会挂靠到两面墙上。

#### 2.4. 几何对齐 (`align_opening_to_wall`)

-   **功能**: 确保门窗的中心点严格位于其挂靠的墙体平面上，保证模型的几何一致性。
-   **算法**:
    1.  **定义墙体平面**: 利用挂靠 `Wall` 对象的三个顶点（如底边两点和顶边一点）在三维空间中定义一个平面方程。
    2.  **几何投影**: 将 `extract_opening_geometry` 计算出的门窗原始中心点，通过标准的三维投影公式，精确地投影到上述墙体平面上。
    3.  **返回修正坐标**: 函数返回投影后的新坐标，这个新坐标将被用于最终创建 `Door` 或 `Window` 对象，从而保证了门窗与墙体的共面性。